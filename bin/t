#!/usr/bin/env bash

scratch="$( ( [[ -d \"$PWD/tmp\" ]] && echo $PWD/tmp ) || echo $PWD/scratch )"
sbin="$scratch/bin"

if [ $# -eq 0 ]; then
  # no arguments given
  if [[ -d "$sbin" ]] ; then
    if [[ ":$PATH:" == *":$sbin:"* ]]; then
      echo "adding $sbin to PATH"
      export PATH="$sbin:$PATH"
    else
      echo "$sbin is in PATH"
    fi
    echo "available scripts:"
    ls $sbin
    exit 0
  else
    echo "$sbin not found"
    exit 1
  fi
fi

# call named command
command=$1
# ensure command doesn't have a trailing space
command=$(echo "$command" | tr -d '[:space:]')
scratchcmd="$scratch/bin/$command"

set -e

if [[ ! -f "$scratchcmd" ]]; then
  read -p "$scratchcmd does not exist, would you like to create it? [Y/n] " -n 1 -r REPLY
  echo
  if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
    # User pressed Y, y, or Enter (default Y), create a new script and open it
    # in the default editor
    printf "#!/usr/bin/env bash\n\necho changme" > "$scratchcmd"
    chmod +x "$scratchcmd"
    if [ ! -z "$EDITOR" ]; then
      exec $EDITOR $scratchcmd
    else
      echo "created $scratchcmd"
    fi
  else
    # User pressed N, n, or other
    echo "Aborting."
    exit 1
  fi
elif [[ ! -x "$scratchcmd" ]]; then
  chmod +x "$scratchcmd"
fi

shift

set -x
exec "$scratchcmd" "$@"
